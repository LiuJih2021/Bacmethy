Bacmethy V 1.0.1
=================
Summary
------------------

Bacmethy, a customizable pipeline based on Docker, is designed to calculate the enrichment significance of methylated and un(der)methylated motifs in the regulatory and coding regions of the genome. It also identifies genes that are co-affected by DNA methylation and transcription factor binding, enabling the prediction of transcriptional regulation effects by DNA methylation. By using Bacmethy, researchers can gain a more comprehensive understanding of bacterial epigenomes.<br>
We offer three ways for utilizing Bacmethy: a web server, a Docker-based system, and a command-line tool. <br>

Requirements
---------------

1. [PROKKA](https://github.com/tseemann/prokka "PROKKA Github")<br>
2. [bedtools](https://bedtools.readthedocs.io/en/latest/ "bedtools Documentation")<br>
3. [meme](https://github.com/cinquin/MEME "meme Github")<br>


Installation
---------------
### 1. WEB Sever users
[Bacmethy Website](https://Bacmethy.med.sustech.edu.cn)
The website includes methylation analysis and TFs binding prediction modules of Bacmethy. <br>
No installation step is needed if using Bacmethy web server.
 
### 2. docker users
Docker image is provided for Windows or Mac users. <br>
#### First Download
1. After [docker](https://docs.docker.com/engine/install/) installation. <br>
    docker pull liujihong/Bacmethy:2.0
    docker run  -t -i liujihong/Bacmethy:2.0 /bin/bash
2. re-enter docker. <br>
    docker start <container_ID>
    docker attach <container_ID>

### 3. command-line tool users
1. Download the scripts from Guthub to your working directory. <br>
2. install required softwares through Conda. <br>
#### First install conda 
    wget -c https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh
    bash Miniconda2-latest-Linux-x86_64.sh
#### creat a Bacmethy conda environment
    conda -n Bacmethy
    conda activate Bacmethy
#### conda install required softwares
    conda install -c bioconda prokka
    conda install -c bioconda bedtools
    conda install -c bioconda meme

Inputs
-----------------
######## 
### 1. genome sequence file 
PacBio provide HGAP4(Hierarchical Genome Assembly Process) as part of [SMRT-LINK](https://www.pacb.com/support/software-downloads/) to generate high quality de novo assemblies of genomes, using Continuous Long Reads.<br> 
For step 2, "Prepare motifs files," it is essential to have **complete genome** sequences obtained from the **same strain** (same reference genome). This means that the genome sequences used for this step should be derived from the exact same bacterial strains. This ensures accuracy and consistency in the analysis of motifs. 

### 2. motifs files
Use Base Modification Analysis Application in [SMRT-LINK](https://www.pacb.com/support/software-downloads/) or SMRT Tools to identify bacterial base modifications, and analyze the methyltransferase recognition motifs. Detection can be down using an in-silico control consisting of expected kinetic signals.<br>
Two files generated by 'Base Modification Analysis' (motifs.gff and motif.csv) are required in Bacmethy analysis. <br>
1. motifs.gff: Compliant with the GFF Version3 [specification](http://www.sequenceontology.org/gff3.shtml). Each template position/strand pair whose probability value exceeds the probability value threshold appears as a row. The template position is 1-based, per the GFF specifications. The strand column refers to the strand carrying the detected modification, which is the opposite strand from those used to detect the modification. The GFF confidence column is a Phred-transformed probability value of detection.<br>
2. motifs.csv: Contains one row for each(reference,position, strand) pair that appeared in the Data Set with coverage at least x.
x defaults to 3, but is configurable with the --minCoverage option. The reference position index is 1-based for compatibility with the GFF file in the R environment. Note that this output type scales poorly and is not recommended for large genomes; the HDF5 output should perform much better in these cases.
ref: https://www.pacb.com/wp-content/uploads/SMRT_Tools_Reference_Guide_v10.1.pdf

### 3. PPM files [OPTION]
TFs (Transcription Factors) binding prediction is an optional function module of Bacmethy. To utilize this module, the TF matrix files in PPM format are needed (with a .meme suffix).

Run Bacmethy
-----------------
### 1. Run Bacmethy.sh
    bash Bacmethy.sh -m motifs.gff -s motifs.csv -g genome.fasta -p PREFIX -t m6A 
#### Usage
    bash Bacmethy.sh -m <motifs.gff> -s <motifs.csv> -g <genome.fa> -p <prefix> -t <m6A, m4C or m5C> [options] -d -b -a -r -T -n
    requirement: locally installed PROKKA,  bedtools and MEME  softwares


    required
        -m      FILE    a motif detected file in gff format from PacBio portal (required)
        -s      FILE    a motifs summary file (required)
        -g      FILE    a genome file which complete sequenced (required)
        -p      STRING  prefix of output (required; usually a strains name or a sample name)
        -t      STRING  a type of methylation type (required; one of m6A, m4C or m5C)
       
    options
        -T      FOLDER  a floder contains TFs files in meme format (required; users can get from Calcute_PPM_console_final.py)
        -d      FLOAT   a undermethylation thresholds of fraction (default: 0.75)
        -i      FLOAT   a unmethylation thresholds of identificationQv (default: 40)
        -c      FLOAT   a unmethylation thresholds of coverage (default: 30)
        -b      INT     number of bps before TSS (default: 500)
        -a      INT     number of bps after TSS (default: 100)
        -r      FILE    FASTA or GBK file to use as 1st priority (default '')
        -n      INT     Number of CPUs to use (default '8')
#### Notice
The genome file used for Bacmethy analysis should be the same genome reference file which used in SMRTLink methylation motif detection analysis.<br>
Additionally, there are two recommended options for better genome annotation:<br>
#### option: **-r** add standard strains reference
The **-r** option allows users to add a reference file from a standard strain in the same species. This helps improve genome annotation.
#### option: **-d** methylation level direction
The **-d** option is used for specifying the methylation level direction. There are complex and dynamic epigenetic regulations involved in DNA methylation. To ensure the authenticity of methylation events, a sequencing coverage higher than 30 is required. 
The software classifies DNA methylation events into three levels: methylation, undermethylation, and unmethylation.<br>
1. methylation: identificationQV >= 40 <br>
2. undermethylation: identificationQV >= 40 && fraction < 0.75 <br>
3. unmethylation: identifictionQV < 40 <br>
The default threshold for undermethylation in Bacmethy is set to a fraction less than 0.75 and an identificationQV greater than or equal to 40.<br>
However, users can also set user-defined thresholds using the -d parameter to change the fraction and the -i parameter to alter the identificationQV threshold.<br>

### 2. example
    Bacmethy.sh -m motifs.gff -s motif_summary.csv -g genomic.fna -p K12 -t m6A -T /Your/Path/To/TF/meme

### 3. Running Time
Bacmethy uses parallel processing to decrease running time on multicore computers.  Users can set Running CPU by parameter **-n**. 


Outputs
-----------------
structure of output files
-   methylation
    -   motif_CDS
    -   motif_RR
-   undermethylation
    -   motif_CDS
    -   motif_RR
-   unmethylation
    -   motif_CDS
    -   motif_RR
    
#### Gene Features
There are 3 gene features, promoter(default: 500bp upstream region before the ATG initiation codon), CDS_RR(default: 100bp downstream region after the initiation codon), Coding Region(Whole Gene coding region). And we defined both promoter and CDS as Regulation Region(RR) in Bacmethy. <br>
##### difference between CDS_RR and Coding Region<br>
Gene transcription initiation is a complex process regulated by multiple factors. The start of the gene body can also play a role in gene transcription initiation regulation. Hence, the term **CDS_RR** is used to describe methylation sites that occur at the start of the coding sequence (CDS) region, which is involved in the regulation of gene transcription.<br>
Some users may be interested specifically in methylation sites that occur within the gene body. For this purpose, Bacmethy provides a separate folder exclusively for these methylation sites, which are classified under the category of **Coding Region**. <br>

#### methylation site distribution
motif_methylationType.methylationLevel_result.txt

| column name | Description |
| --- | --- |
| Strains | Strain name |
| Methylation | Methylation type |
| nCDS | counts of methylated bases in CDS region |
| nPROMOTER | counts of methylated bases in promoter |
| nRR | counts of methylated bases in Regulation Region |


#### methylated gene result

motif_methylationType.methylationLevel_methylationGene.txt

| column name | Description |
| --- | --- |
| Strains | Strain name |
| Methylation | Methylation type |
| Region | the region which the methylation site located, CDS or promoter |
| RRS | Regulation region start site |
| RRE | Regulation region end site |
| Methsite | the methylation site |
| Fraction | Estimate of the fraction of molecules that carry the modification |
| distance | the distance between the start site of gene orf and methylated site |
| start | gene start site |
| end | gene end site |
| strand | the gene transcription direction, +/- |
| locus tag | the gene position ID |
| gene name | gene name annotated by prokka |
| description | gene function annotation |

motif_methylationType.methylationLevel_raw_methylationGene.txt

| column name | Description |
| --- | --- |
| Strains | Strain name |
| Methylation | Methylation type |
| Region | the region which the methylation site located, CDS or promoter |
| RRS | Regulation region start site |
| RRE | Regulation region end site |
| Methsite | the methylation site |
| distance | the distance between the start site of gene orf and methylated site |
| start | gene start site |
| end | gene end site |
| strand | the gene transcription direction, +/- |
| locus tag | the gene position ID |
| gene name | gene name annotated by prokka |
| description | gene function annotation |


#### the overlap of methylation site and TF binding
motif_methylationType.methylationLevel_TF.meme.txt

| column name | Description |
| --- | --- |
| Strains | Strain name |
| Methylation |                                                                                                                                                   Methylation type                                    |
| TF binding start |  TF binding position start site |
| TF binding end |  TF binding position end site |
| FIMO score | the TF which binding with RR or CDS region in FIMO scan score |
| Region | the region which the methylation site located, CDS or promoter |
| RRS | Regulation region start site |
| RRE | Regulation region end site |
| Methsite | the methylation site |
| Fraction | Estimate of the fraction of molecules that carry the modification |
| distance | the distance between the start site of gene orf and methylated site |
| start | gene start site |
| end | gene end site |
| strand | the gene transcription direction, +/- |
| locus tag | the gene position ID |
| gene name | gene name annotated by prokka |
| description | gene function annotation |

#### whole modified base of this motif in this genome
motif_methylationType_motif.methylationLevel<br>
e.g. GATC_m6A_motif.methylation<br>
#### Explanation
Using Calcute_PPM_console_final.py for generating meme format TFs file
---------------------
### Usage
    python ./script/Calcute_PPM_console_final.py  TF.mat
Coming updates
----------------
1. Incomplete genome assembly data<br>

Copyright
-------------------------
